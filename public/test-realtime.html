<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®æ—¶é€šä¿¡æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .reconnecting { background-color: #fff3cd; color: #856404; }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }
    </style>
</head>
<body>
    <h1>ğŸ”— å®æ—¶é€šä¿¡æµ‹è¯•</h1>
    
    <div id="status" class="status disconnected">
        çŠ¶æ€: æœªè¿æ¥
    </div>
    
    <div>
        <button id="connectBtn" class="btn-primary">è¿æ¥</button>
        <button id="disconnectBtn" class="btn-secondary">æ–­å¼€</button>
        <button id="testSSEBtn" class="btn-primary">æµ‹è¯•SSE</button>
        <button id="testPollBtn" class="btn-primary">æµ‹è¯•é•¿è½®è¯¢</button>
        <button id="clearLogBtn" class="btn-danger">æ¸…é™¤æ—¥å¿—</button>
    </div>
    
    <h3>ğŸ“‹ è¿æ¥æ—¥å¿—</h3>
    <div id="log" class="log"></div>
    
    <h3>ğŸ§ª æµ‹è¯•ä¿¡æ¯</h3>
    <ul>
        <li><strong>è®¾å¤‡ID:</strong> <span id="deviceId">-</span></li>
        <li><strong>è¿æ¥ç±»å‹:</strong> <span id="connectionType">-</span></li>
        <li><strong>é‡è¿æ¬¡æ•°:</strong> <span id="reconnectCount">0</span></li>
        <li><strong>æ¶ˆæ¯è®¡æ•°:</strong> <span id="messageCount">0</span></li>
    </ul>

    <script>
        // ç®€åŒ–çš„å·¥å…·å‡½æ•°
        const Utils = {
            getDeviceId() {
                let deviceId = localStorage.getItem('deviceId');
                if (!deviceId) {
                    deviceId = 'web-' + Date.now() + '-' + Math.random().toString(36).substring(2);
                    localStorage.setItem('deviceId', deviceId);
                }
                return deviceId;
            }
        };

        // ç®€åŒ–çš„UIå‡½æ•°
        const UI = {
            setConnectionStatus(status) {
                const statusEl = document.getElementById('status');
                statusEl.className = `status ${status}`;
                statusEl.textContent = `çŠ¶æ€: ${status}`;
            }
        };

        // æ—¥å¿—å‡½æ•°
        function log(message) {
            const logEl = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logEl.innerHTML += `[${time}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        // æ›´æ–°æµ‹è¯•ä¿¡æ¯
        function updateTestInfo() {
            document.getElementById('deviceId').textContent = Utils.getDeviceId();
            document.getElementById('connectionType').textContent = window.testRealtime ? 
                (window.testRealtime.eventSource ? 'SSE' : 
                 window.testRealtime.longPollingActive ? 'é•¿è½®è¯¢' : 'æ— ') : 'æ— ';
            document.getElementById('reconnectCount').textContent = window.testRealtime ? 
                window.testRealtime.reconnectAttempts : 0;
        }

        // ç®€åŒ–çš„å®æ—¶é€šä¿¡ç®¡ç†å™¨ï¼ˆä»…ç”¨äºæµ‹è¯•ï¼‰
        class TestRealtimeManager {
            constructor() {
                this.eventSource = null;
                this.isConnected = false;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 3;
                this.deviceId = Utils.getDeviceId();
                this.longPollingActive = false;
                this.messageCount = 0;
            }

            // æµ‹è¯•SSEè¿æ¥
            testSSE() {
                log('ğŸ”— æµ‹è¯•SSEè¿æ¥...');
                
                try {
                    const url = `/api/events?deviceId=${encodeURIComponent(this.deviceId)}`;
                    this.eventSource = new EventSource(url);

                    this.eventSource.addEventListener('connection', (event) => {
                        log('âœ… SSEè¿æ¥æˆåŠŸ');
                        this.isConnected = true;
                        UI.setConnectionStatus('connected');
                        updateTestInfo();
                    });

                    this.eventSource.addEventListener('message', (event) => {
                        this.messageCount++;
                        log(`ğŸ“¨ æ”¶åˆ°SSEæ¶ˆæ¯: ${event.data}`);
                        document.getElementById('messageCount').textContent = this.messageCount;
                    });

                    this.eventSource.addEventListener('heartbeat', (event) => {
                        log('ğŸ’“ æ”¶åˆ°å¿ƒè·³');
                    });

                    this.eventSource.onerror = (event) => {
                        log('âŒ SSEè¿æ¥é”™è¯¯');
                        this.isConnected = false;
                        UI.setConnectionStatus('disconnected');
                        updateTestInfo();
                    };

                } catch (error) {
                    log(`âŒ SSEè¿æ¥å¤±è´¥: ${error.message}`);
                }
            }

            // æµ‹è¯•é•¿è½®è¯¢
            async testLongPolling() {
                log('ğŸ”— æµ‹è¯•é•¿è½®è¯¢...');
                this.longPollingActive = true;
                this.longPoll();
                updateTestInfo();
            }

            async longPoll() {
                if (!this.longPollingActive) return;

                try {
                    const url = `/api/poll?deviceId=${encodeURIComponent(this.deviceId)}&lastMessageId=0&timeout=10`;
                    log(`ğŸ”„ å‘èµ·é•¿è½®è¯¢è¯·æ±‚: ${url}`);
                    
                    const response = await fetch(url);
                    const data = await response.json();

                    if (data.success) {
                        this.messageCount++;
                        log(`âœ… é•¿è½®è¯¢å“åº”: ${JSON.stringify(data)}`);
                        document.getElementById('messageCount').textContent = this.messageCount;
                        
                        if (!this.isConnected) {
                            this.isConnected = true;
                            UI.setConnectionStatus('connected');
                        }
                    } else {
                        log(`âŒ é•¿è½®è¯¢å¤±è´¥: ${data.error}`);
                    }

                } catch (error) {
                    log(`âŒ é•¿è½®è¯¢è¯·æ±‚å¤±è´¥: ${error.message}`);
                    this.isConnected = false;
                    UI.setConnectionStatus('disconnected');
                }

                // ç»§ç»­ä¸‹ä¸€æ¬¡è½®è¯¢
                if (this.longPollingActive) {
                    setTimeout(() => this.longPoll(), 2000);
                }
            }

            disconnect() {
                if (this.eventSource) {
                    this.eventSource.close();
                    this.eventSource = null;
                }
                this.longPollingActive = false;
                this.isConnected = false;
                UI.setConnectionStatus('disconnected');
                log('ğŸ”Œ è¿æ¥å·²æ–­å¼€');
                updateTestInfo();
            }
        }

        // åˆ›å»ºæµ‹è¯•å®ä¾‹
        window.testRealtime = new TestRealtimeManager();

        // ç»‘å®šæŒ‰é’®äº‹ä»¶
        document.getElementById('connectBtn').addEventListener('click', () => {
            window.testRealtime.testSSE();
        });

        document.getElementById('disconnectBtn').addEventListener('click', () => {
            window.testRealtime.disconnect();
        });

        document.getElementById('testSSEBtn').addEventListener('click', () => {
            window.testRealtime.testSSE();
        });

        document.getElementById('testPollBtn').addEventListener('click', () => {
            window.testRealtime.testLongPolling();
        });

        document.getElementById('clearLogBtn').addEventListener('click', () => {
            document.getElementById('log').innerHTML = '';
        });

        // åˆå§‹åŒ–
        updateTestInfo();
        log('ğŸš€ æµ‹è¯•é¡µé¢å·²åŠ è½½');
    </script>
</body>
</html>
