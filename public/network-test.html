<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç½‘ç»œè¿æ¥æµ‹è¯• - å¾®ä¿¡æ–‡ä»¶ä¼ è¾“åŠ©æ‰‹</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .status-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #07c160;
        }
        
        .test-button {
            background: #07c160;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: background 0.3s;
        }
        
        .test-button:hover {
            background: #06ad56;
        }
        
        .test-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .result-area {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .indicator.online { background: #28a745; }
        .indicator.offline { background: #dc3545; }
        .indicator.unknown { background: #ffc107; }
        
        .mobile-info {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 6px 6px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒ ç½‘ç»œè¿æ¥æµ‹è¯•</h1>
            <p>ç§»åŠ¨ç«¯ç½‘ç»œè¿æ¥é—®é¢˜è¯Šæ–­å·¥å…·</p>
        </div>
        
        <div class="status-card">
            <h3>ğŸ“Š å½“å‰ç½‘ç»œçŠ¶æ€</h3>
            <div id="networkStatus">æ­£åœ¨æ£€æµ‹...</div>
        </div>
        
        <div class="mobile-info" id="mobileInfo" style="display: none;">
            <h3>ğŸ“± ç§»åŠ¨ç«¯ä¿¡æ¯</h3>
            <div id="mobileDetails"></div>
        </div>
        
        <div class="status-card">
            <h3>ğŸ”§ æµ‹è¯•å·¥å…·</h3>
            <button class="test-button" onclick="runBasicTest()">åŸºç¡€è¿é€šæ€§æµ‹è¯•</button>
            <button class="test-button" onclick="runMobileDiagnosis()">ç§»åŠ¨ç«¯è¯Šæ–­</button>
            <button class="test-button" onclick="testEventSource()">EventSourceæµ‹è¯•</button>
            <button class="test-button" onclick="clearResults()">æ¸…é™¤ç»“æœ</button>
        </div>
        
        <div class="status-card">
            <h3>ğŸ“‹ æµ‹è¯•ç»“æœ</h3>
            <div class="result-area" id="testResults">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
        </div>
        
        <div class="status-card">
            <h3>ğŸ”— å¿«é€Ÿé“¾æ¥</h3>
            <a href="/" class="test-button" style="text-decoration: none; display: inline-block;">è¿”å›ä¸»åº”ç”¨</a>
            <a href="/login.html" class="test-button" style="text-decoration: none; display: inline-block;">ç™»å½•é¡µé¢</a>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="./js/config.js"></script>
    <script src="./js/utils.js"></script>
    <script src="./js/networkManager.js"></script>
    
    <script>
        let testResults = '';
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            updateNetworkStatus();
            checkMobileDevice();
            
            // ç›‘å¬ç½‘ç»œçŠ¶æ€å˜åŒ–
            if (typeof NetworkManager !== 'undefined') {
                NetworkManager.on('statusChange', updateNetworkStatus);
                NetworkManager.on('qualityChange', updateNetworkStatus);
            }
            
            // å®šæœŸæ›´æ–°çŠ¶æ€
            setInterval(updateNetworkStatus, 5000);
        });
        
        // æ›´æ–°ç½‘ç»œçŠ¶æ€æ˜¾ç¤º
        function updateNetworkStatus() {
            const statusDiv = document.getElementById('networkStatus');
            
            if (typeof NetworkManager !== 'undefined') {
                const status = NetworkManager.getStatus();
                
                const indicator = status.isOnline ? 'online' : 'offline';
                const statusText = status.isOnline ? 'åœ¨çº¿' : 'ç¦»çº¿';
                const quality = status.quality || 'unknown';
                
                statusDiv.innerHTML = `
                    <div><span class="indicator ${indicator}"></span><strong>è¿æ¥çŠ¶æ€:</strong> ${statusText}</div>
                    <div style="margin-top: 8px;"><strong>ç½‘ç»œè´¨é‡:</strong> ${quality}</div>
                    <div style="margin-top: 8px;"><strong>è®¾å¤‡ç±»å‹:</strong> ${status.isMobile ? 'ç§»åŠ¨ç«¯' : 'æ¡Œé¢ç«¯'}</div>
                    <div style="margin-top: 8px;"><strong>PWAæ¨¡å¼:</strong> ${status.isPWA ? 'æ˜¯' : 'å¦'}</div>
                    <div style="margin-top: 8px;"><strong>æœ€åæ£€æµ‹:</strong> ${new Date().toLocaleTimeString()}</div>
                `;
            } else {
                statusDiv.innerHTML = `
                    <div><span class="indicator unknown"></span><strong>NetworkManageræœªåŠ è½½</strong></div>
                    <div style="margin-top: 8px;">æµè§ˆå™¨çŠ¶æ€: ${navigator.onLine ? 'åœ¨çº¿' : 'ç¦»çº¿'}</div>
                `;
            }
        }
        
        // æ£€æŸ¥ç§»åŠ¨è®¾å¤‡ä¿¡æ¯
        function checkMobileDevice() {
            const isMobile = /Mobile|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (isMobile) {
                const mobileInfo = document.getElementById('mobileInfo');
                const mobileDetails = document.getElementById('mobileDetails');
                
                mobileInfo.style.display = 'block';
                
                let details = `
                    <div><strong>User Agent:</strong> ${navigator.userAgent}</div>
                    <div style="margin-top: 8px;"><strong>å±å¹•å°ºå¯¸:</strong> ${screen.width}x${screen.height}</div>
                    <div style="margin-top: 8px;"><strong>è§†å£å°ºå¯¸:</strong> ${window.innerWidth}x${window.innerHeight}</div>
                `;
                
                if (navigator.connection) {
                    details += `
                        <div style="margin-top: 8px;"><strong>ç½‘ç»œç±»å‹:</strong> ${navigator.connection.effectiveType}</div>
                        <div style="margin-top: 8px;"><strong>ä¸‹è¡Œé€Ÿåº¦:</strong> ${navigator.connection.downlink} Mbps</div>
                        <div style="margin-top: 8px;"><strong>å¾€è¿”æ—¶é—´:</strong> ${navigator.connection.rtt} ms</div>
                    `;
                }
                
                mobileDetails.innerHTML = details;
            }
        }
        
        // åŸºç¡€è¿é€šæ€§æµ‹è¯•
        async function runBasicTest() {
            addResult('ğŸ” å¼€å§‹åŸºç¡€è¿é€šæ€§æµ‹è¯•...\n');
            
            try {
                const startTime = Date.now();
                const response = await fetch('/api/messages?limit=1', {
                    method: 'GET',
                    cache: 'no-cache'
                });
                const endTime = Date.now();
                
                const latency = endTime - startTime;
                
                if (response.ok) {
                    addResult(`âœ… åŸºç¡€è¿é€šæ€§æµ‹è¯•é€šè¿‡\n   å»¶è¿Ÿ: ${latency}ms\n   çŠ¶æ€: ${response.status}\n\n`);
                } else {
                    addResult(`âŒ åŸºç¡€è¿é€šæ€§æµ‹è¯•å¤±è´¥\n   çŠ¶æ€: ${response.status}\n   å»¶è¿Ÿ: ${latency}ms\n\n`);
                }
            } catch (error) {
                addResult(`âŒ åŸºç¡€è¿é€šæ€§æµ‹è¯•å¤±è´¥\n   é”™è¯¯: ${error.message}\n\n`);
            }
        }
        
        // ç§»åŠ¨ç«¯è¯Šæ–­
        async function runMobileDiagnosis() {
            if (typeof NetworkManager === 'undefined') {
                addResult('âŒ NetworkManageræœªåŠ è½½ï¼Œæ— æ³•è¿›è¡Œç§»åŠ¨ç«¯è¯Šæ–­\n\n');
                return;
            }
            
            addResult('ğŸ“± å¼€å§‹ç§»åŠ¨ç«¯ç½‘ç»œè¯Šæ–­...\n');
            
            try {
                const diagnosis = await NetworkManager.diagnoseMobileNetwork();
                
                if (diagnosis.error) {
                    addResult(`âŒ è¯Šæ–­å¤±è´¥: ${diagnosis.error}\n\n`);
                    return;
                }
                
                const report = NetworkManager.generateDiagnosisReport(diagnosis);
                addResult(report + '\n\n');
                
            } catch (error) {
                addResult(`âŒ ç§»åŠ¨ç«¯è¯Šæ–­å¤±è´¥: ${error.message}\n\n`);
            }
        }
        
        // EventSourceæµ‹è¯•
        function testEventSource() {
            addResult('ğŸ”— å¼€å§‹EventSourceè¿æ¥æµ‹è¯•...\n');
            
            if (typeof EventSource === 'undefined') {
                addResult('âŒ æµè§ˆå™¨ä¸æ”¯æŒEventSource\n\n');
                return;
            }
            
            try {
                const eventSource = new EventSource('/api/events?test=1');
                let connected = false;
                
                const timeout = setTimeout(() => {
                    if (!connected) {
                        eventSource.close();
                        addResult('â° EventSourceè¿æ¥è¶…æ—¶\n\n');
                    }
                }, 10000);
                
                eventSource.addEventListener('connection', () => {
                    connected = true;
                    clearTimeout(timeout);
                    addResult('âœ… EventSourceè¿æ¥æˆåŠŸ\n');
                    
                    setTimeout(() => {
                        eventSource.close();
                        addResult('ğŸ”Œ EventSourceè¿æ¥å·²å…³é—­\n\n');
                    }, 2000);
                });
                
                eventSource.onerror = (error) => {
                    clearTimeout(timeout);
                    addResult(`âŒ EventSourceè¿æ¥å¤±è´¥\n   ReadyState: ${eventSource.readyState}\n\n`);
                    eventSource.close();
                };
                
            } catch (error) {
                addResult(`âŒ EventSourceæµ‹è¯•å¤±è´¥: ${error.message}\n\n`);
            }
        }
        
        // æ·»åŠ æµ‹è¯•ç»“æœ
        function addResult(text) {
            testResults += text;
            document.getElementById('testResults').textContent = testResults;
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            const resultArea = document.getElementById('testResults');
            resultArea.scrollTop = resultArea.scrollHeight;
        }
        
        // æ¸…é™¤ç»“æœ
        function clearResults() {
            testResults = '';
            document.getElementById('testResults').textContent = 'ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•...';
        }
    </script>
</body>
</html>
